name: Sync Upstream Repositories

on:
  schedule:
    # æ¯å¤©UTC 02:00 (åŒ—äº¬æ—¶é—´10:00) è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync all repositories'
        required: false
        default: 'false'
        type: boolean
      target_repo:
        description: 'Specific repository to sync (leave empty for all)'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'meme-generator'
          - 'meme-generator-contrib'
          - 'meme_emoji'

jobs:
  sync-repositories:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # å…è®¸å…¶ä»–ä»»åŠ¡ç»§ç»­æ‰§è¡Œï¼Œå³ä½¿æŸä¸ªä»»åŠ¡å¤±è´¥
      matrix:
        repo:
          - name: "meme-generator"
            upstream: "https://github.com/MemeCrafters/meme-generator.git"
            local_path: "core"
            branch: "main"
          - name: "meme-generator-contrib"
            upstream: "https://github.com/MemeCrafters/meme-generator-contrib.git"
            local_path: "contrib"
            branch: "main"
          - name: "meme_emoji"
            upstream: "https://github.com/anyliew/meme_emoji.git"
            local_path: "emoji"
            branch: "main"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          submodules: recursive

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global init.defaultBranch main

      - name: Debug environment and permissions
        run: |
          echo "=== Environment Debug Info ==="
          echo "Current directory: $(pwd)"
          echo "Git version: $(git --version)"
          echo "Repository status:"
          git status
          echo ""
          echo "Submodules status:"
          git submodule status || echo "No submodules found or error occurred"
          echo ""
          echo "Available directories:"
          ls -la
          echo ""
          echo "Checking target submodule directory: ${{ matrix.repo.local_path }}"
          if [ -d "${{ matrix.repo.local_path }}" ]; then
            echo "Directory exists, contents:"
            ls -la ${{ matrix.repo.local_path }}
          else
            echo "Directory does not exist"
          fi

      - name: Initialize and setup submodule for ${{ matrix.repo.name }}
        run: |
          echo "Checking submodule ${{ matrix.repo.local_path }}..."
          
          # ç¡®ä¿å­æ¨¡å—å·²åˆå§‹åŒ–
          if [ ! -d "${{ matrix.repo.local_path }}" ]; then
            echo "Submodule directory ${{ matrix.repo.local_path }} does not exist, initializing..."
            git submodule update --init --recursive ${{ matrix.repo.local_path }}
          fi
          
          # æ£€æŸ¥å­æ¨¡å—æ˜¯å¦ä¸ºç©ºç›®å½•
          if [ ! -d "${{ matrix.repo.local_path }}/.git" ] && [ ! -f "${{ matrix.repo.local_path }}/.git" ]; then
            echo "Submodule ${{ matrix.repo.local_path }} not properly initialized, forcing update..."
            git submodule update --init --recursive --force ${{ matrix.repo.local_path }}
          fi
          
          # è¿›å…¥å­æ¨¡å—ç›®å½•
          cd ${{ matrix.repo.local_path }}
          
          # æ£€æŸ¥æ˜¯å¦åœ¨detached HEADçŠ¶æ€
          current_branch=$(git branch --show-current)
          if [ -z "$current_branch" ]; then
            echo "In detached HEAD state, checking out main branch..."
            git checkout -b main 2>/dev/null || git checkout main 2>/dev/null || git checkout master 2>/dev/null
          fi
          
          # è®¾ç½®ä¸Šæ¸¸è¿œç¨‹ä»“åº“
          if git remote | grep -q "^upstream$"; then
            git remote remove upstream
          fi
          git remote add upstream ${{ matrix.repo.upstream }}
          
          # æ·»åŠ é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
          for i in {1..3}; do
            if git fetch upstream; then
              echo "Successfully fetched from upstream"
              break
            else
              echo "Attempt $i failed, retrying in 10 seconds..."
              sleep 10
              if [ $i -eq 3 ]; then
                echo "Failed to fetch from upstream after 3 attempts"
                exit 1
              fi
            fi
          done

      - name: Check for updates
        id: check_updates
        run: |
          cd ${{ matrix.repo.local_path }}
          
          # è·å–æœ¬åœ°æäº¤
          LOCAL_COMMIT=$(git rev-parse HEAD)
          echo "Local commit: $LOCAL_COMMIT"
          
          # å°è¯•è·å–ä¸Šæ¸¸æäº¤ï¼Œæ”¯æŒmainå’Œmasteråˆ†æ”¯
          UPSTREAM_COMMIT=""
          if git rev-parse upstream/main >/dev/null 2>&1; then
            UPSTREAM_COMMIT=$(git rev-parse upstream/main)
            UPSTREAM_BRANCH="main"
          elif git rev-parse upstream/master >/dev/null 2>&1; then
            UPSTREAM_COMMIT=$(git rev-parse upstream/master)
            UPSTREAM_BRANCH="master"
          else
            echo "Error: Could not find upstream/main or upstream/master branch"
            exit 1
          fi
          
          echo "Upstream commit: $UPSTREAM_COMMIT (branch: $UPSTREAM_BRANCH)"
          
          echo "local_commit=$LOCAL_COMMIT" >> $GITHUB_OUTPUT
          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
          echo "upstream_branch=$UPSTREAM_BRANCH" >> $GITHUB_OUTPUT
          
          if [ "$LOCAL_COMMIT" != "$UPSTREAM_COMMIT" ] || [ "${{ github.event.inputs.force_sync }}" = "true" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "Updates found for ${{ matrix.repo.name }}"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No updates for ${{ matrix.repo.name }}"
          fi

      - name: Attempt automatic merge
        if: steps.check_updates.outputs.has_updates == 'true'
        id: auto_merge
        run: |
          cd ${{ matrix.repo.local_path }}
          
          # ä½¿ç”¨æ£€æµ‹åˆ°çš„ä¸Šæ¸¸åˆ†æ”¯è¿›è¡Œåˆå¹¶
          upstream_branch="${{ steps.check_updates.outputs.upstream_branch }}"
          echo "Attempting to merge upstream/$upstream_branch"
          
          # é¦–å…ˆå°è¯•æ­£å¸¸åˆå¹¶
          merge_output=$(git merge upstream/$upstream_branch --no-edit 2>&1)
          merge_exit_code=$?
          
          if [ $merge_exit_code -eq 0 ]; then
            echo "merge_success=true" >> $GITHUB_OUTPUT
            echo "Auto merge successful for ${{ matrix.repo.name }}"
          else
            echo "Normal merge failed with exit code $merge_exit_code"
            echo "Merge output: $merge_output"
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯unrelated historiesé—®é¢˜
            if echo "$merge_output" | grep -q "refusing to merge unrelated histories"; then
              echo "Detected unrelated histories, attempting merge with --allow-unrelated-histories"
              
              # é‡ç½®åˆ°åˆå¹¶å‰çŠ¶æ€
              git reset --hard HEAD
              
              # å°è¯•ä½¿ç”¨--allow-unrelated-historiesåˆå¹¶
              if git merge upstream/$upstream_branch --allow-unrelated-histories --no-edit; then
                echo "merge_success=true" >> $GITHUB_OUTPUT
                echo "Merge with --allow-unrelated-histories successful for ${{ matrix.repo.name }}"
              else
                echo "merge_success=false" >> $GITHUB_OUTPUT
                echo "Merge with --allow-unrelated-histories failed for ${{ matrix.repo.name }}, conflicts detected"
                git merge --abort 2>/dev/null || true
              fi
            else
              echo "merge_success=false" >> $GITHUB_OUTPUT
              echo "Auto merge failed for ${{ matrix.repo.name }}, conflicts detected"
              git merge --abort 2>/dev/null || true
            fi
          fi

      - name: Commit and push successful merge
        if: steps.check_updates.outputs.has_updates == 'true' && steps.auto_merge.outputs.merge_success == 'true'
        run: |
          cd ${{ matrix.repo.local_path }}
          # æ£€æŸ¥å½“å‰åˆ†æ”¯å¹¶æ¨é€åˆ°æ­£ç¡®çš„åˆ†æ”¯
          current_branch=$(git branch --show-current)
          if [ -z "$current_branch" ]; then
            # å¦‚æœåœ¨detached HEADçŠ¶æ€ï¼Œåˆ‡æ¢åˆ°ä¸»åˆ†æ”¯
            git checkout -b main || git checkout main
            current_branch="main"
          fi
          git push origin $current_branch
          echo "Successfully synced ${{ matrix.repo.name }} to branch $current_branch"

      - name: Create PR for conflicted merge
        if: steps.check_updates.outputs.has_updates == 'true' && steps.auto_merge.outputs.merge_success == 'false'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "sync: Update ${{ matrix.repo.name }} from upstream"
          title: "ğŸ”„ Sync ${{ matrix.repo.name }} - Manual Review Required"
          body: |
            ## ğŸ”„ Upstream Sync for ${{ matrix.repo.name }}
            
            This PR contains updates from the upstream repository that require manual review due to conflicts.
            
            **Upstream Repository:** ${{ matrix.repo.upstream }}
            **Local Commit:** `${{ steps.check_updates.outputs.local_commit }}`
            **Upstream Commit:** `${{ steps.check_updates.outputs.upstream_commit }}`
            
            ### ğŸ“‹ Manual Steps Required:
            1. Review the conflicts in the changed files
            2. Resolve conflicts manually
            3. Test the integration
            4. Merge this PR
            
            ### ğŸ” Files to Review:
            Please check the following areas for potential issues:
            - Configuration files
            - Dependencies in requirements.txt/pyproject.toml
            - API compatibility
            - New meme implementations
            
            ---
            *This PR was automatically created by the sync workflow.*
          branch: sync/${{ matrix.repo.name }}-${{ github.run_number }}
          delete-branch: true

  build-and-test:
    needs: sync-repositories
    runs-on: ubuntu-latest
    if: always() && !cancelled()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-glx \
            libglib2.0-0 \
            libsm6 \
            libxext6 \
            libxrender-dev \
            libgomp1 \
            libglib2.0-0 \
            libgthread-2.0-0 \
            libfontconfig1 \
            libxrender1 \
            libegl1-mesa \
            libgles2-mesa \
            xvfb

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # å®‰è£…æ ¸å¿ƒæ¨¡å—ä¾èµ–
          if [ -f core/requirements.txt ]; then
            pip install -r core/requirements.txt
          fi
          if [ -f core/pyproject.toml ]; then
            cd core && pip install -e .
            cd ..
          fi

      - name: Test meme generator import (with virtual display)
        run: |
          # ä½¿ç”¨è™šæ‹Ÿæ˜¾ç¤ºå™¨è¿è¡Œæµ‹è¯•
          xvfb-run -a python -c "
          import sys
          import os
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          os.environ['DISPLAY'] = ':99'
          os.environ['QT_QPA_PLATFORM'] = 'offscreen'
          
          # æ·»åŠ æ ¸å¿ƒæ¨¡å—åˆ°è·¯å¾„
          sys.path.insert(0, './core')
          
          try:
              import meme_generator
              print('âœ… Core meme_generator imported successfully')
          except ImportError as e:
              print(f'âš ï¸ Import error (may be expected in CI): {e}')
              print('Checking if core module files exist...')
              import os
              if os.path.exists('./core/meme_generator'):
                  print('âœ… Core meme_generator directory exists')
                  files = os.listdir('./core/meme_generator')
                  print(f'Files in meme_generator: {files[:10]}...')  # Show first 10 files
              else:
                  print('âŒ Core meme_generator directory not found')
                  sys.exit(1)
          except Exception as e:
              print(f'âš ï¸ Other error (may be expected in CI): {e}')
              print('This may be due to missing GUI dependencies in CI environment')
          "

      - name: Build Docker image
        run: |
          docker build -t meme-generator-unified:test -f docker/Dockerfile .

      - name: Test Docker container
        run: |
          docker run --rm -d --name test-container -p 2233:2233 meme-generator-unified:test
          sleep 30
          
          # æµ‹è¯•å¥åº·æ£€æŸ¥
          if curl -f http://localhost:2233/docs; then
            echo "âœ… Docker container is healthy"
          else
            echo "âŒ Docker container health check failed"
            docker logs test-container
            exit 1
          fi
          
          docker stop test-container

  notify:
    needs: [sync-repositories, build-and-test]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Notify completion
        run: |
          echo "ğŸ‰ Sync workflow completed"
          echo "Sync status: ${{ needs.sync-repositories.result }}"
          echo "Build status: ${{ needs.build-and-test.result }}"